<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Nuke Effects – Terrain 3D + Population + Shelter HUD</title>

<!-- MapLibre (3D/WebGL) + Leaflet (fallback) -->
<link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet">
<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<style>
:root{
  --bg:#101114;--panel:#0f1318;--muted:#8a95a7;--fg:#e9eef7;--accent:#22d3ee;
  --ok:#22c55e;--warn:#f59e0b;--psi20:#6d28d9;--psi5:#3b82f6;--psi1:#22d3ee;--therm:#f97316;--fall:#22c55e;
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}
#app{display:grid;grid-template-rows:auto 1fr;height:100%}
#bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px;background:var(--panel);box-shadow:0 2px 0 #0008;z-index:12}
#bar .label{font-size:12px;opacity:.85;margin-right:4px}
#bar input,#bar select,#bar button{background:#0b0e12;border:1px solid #1d2633;color:var(--fg);padding:6px 8px;border-radius:10px}
#bar button{cursor:pointer}
#mapwrap{position:relative}
#mlmap,#map{position:absolute;inset:0}

#stack{position:absolute;right:10px;top:10px;display:flex;flex-direction:column;gap:10px;z-index:10;width:min(92vw,320px)}
.panel{background:#0b0e12dd;border:1px solid #1d2633;border-radius:10px;backdrop-filter:blur(4px)}
.panel header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #1d2633;cursor:pointer}
.panel .content{padding:8px 10px;display:none}
.panel.open .content{display:block}
.badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:12px}
.b20{background:var(--psi20)} .b5{background:var(--psi5)} .b1{background:var(--psi1)} .bth{background:var(--therm)} .bfo{background:var(--fall)}
.note{color:var(--muted);font-size:12px}
.row{display:flex;align-items:center;gap:8px;margin:6px 0}
.row input[type="range"]{width:100%;accent-color:var(--accent)}
.smallbtn{padding:4px 8px;border-radius:8px;border:1px solid #1d2633;background:#0b0e12;color:var(--fg);cursor:pointer}
.mini-help{font-size:11px;color:#9aa6b2}

#windHUD{position:absolute;left:10px;bottom:10px;z-index:11;background:#0b0e12ee;border:1px solid #1d2633;border-radius:12px;box-shadow:0 2px 8px #0008;min-width:220px}
#windHead{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px 10px;border-bottom:1px solid #1d2633;cursor:move}
#windBody{display:flex;gap:10px;align-items:center;padding:8px 10px}
#windCompass{display:block}
#windResize{position:absolute;right:4px;bottom:4px;width:18px;height:18px;border-right:2px solid #334155;border-bottom:2px solid #334155;border-radius:3px;cursor:nwse-resize}
#windFoot{display:flex;gap:6px;padding:0 10px 10px 10px;flex-wrap:wrap}
#windFoot input{width:84px}

.err{position:absolute;left:10px;top:10px;background:#7f1d1d;color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:20}
.hint{position:absolute;left:50%;bottom:20px;transform:translateX(-50%);background:#1e293b;color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:20}
#status{position:absolute;left:10px;bottom:10px;background:#0b0e12aa;color:#e9eef7;padding:4px 8px;font-size:12px;border-radius:6px;z-index:5}

/* pin styles */
.pin-list{max-height:160px;overflow:auto;border:1px solid #1d2633;border-radius:8px;padding:6px}
.pin-item{display:flex;justify-content:space-between;align-items:center;gap:6px;padding:4px;border-bottom:1px dashed #203040}
.pin-item:last-child{border-bottom:none}
.pin-item .meta{font-size:12px;color:#aab4c3}
.pin-item button{padding:3px 6px}
.pin-swatch{width:14px;height:14px;border-radius:3px;border:1px solid #1d2633;display:inline-block;vertical-align:middle;margin-right:4px}
</style>
</head>
<body>
<div id="app">
  <!-- Top control bar -->
  <div id="bar">
    <span class="label">Burst:</span>
    <select id="preset">
      <option value="custom">Custom</option>
      <option value="15">Little Boy (15 kt)</option>
      <option value="100" selected>W76 (100 kt)</option>
      <option value="475">W88 (475 kt)</option>
      <option value="1200">B83 (1.2 Mt)</option>
      <option value="50000">Tsar Bomba (50 Mt)</option>
    </select>
    <span class="label">Yield</span><input id="yield" type="number" min="0.1" step="0.1" value="100" style="width:84px">kt
    <span class="label">Alt</span><input id="alt" type="number" step="10" value="0" style="width:80px">m
    <label><input id="fallout" type="checkbox" checked> Fallout</label>
    <span class="label">WX</span>
    <select id="wx"><option value="dry">Dry</option><option value="rain">Rain</option><option value="snow">Snow</option></select>
    <span class="label">Wind</span>
    <input id="wind" type="number" min="0" max="359" step="1" value="90" style="width:70px">°
    <span class="label">Speed</span>
    <input id="windSpd" type="number" min="0" max="60" step="1" value="10" style="width:70px">m/s
    <button id="liveWind">Live wind</button>
    <button id="add">Add burst (tap map)</button>
    <button id="pinMode">Add pin (tap map)</button>
    <button id="clear">Clear</button>
    <button id="refreshTiles">Refresh tiles</button>
    <label><input id="popHeatTop" type="checkbox"> Pop heat</label>
    <span class="label">Basemap</span>
    <select id="basemap"><option value="auto" selected>Auto</option><option value="osm">OSM Streets</option><option value="sat">ESRI Satellite</option><option value="grid">Offline grid</option></select>
  </div>

  <!-- Map stack -->
  <div id="mapwrap">
    <div id="mlmap"></div>
    <div id="map"></div>

    <!-- Right overlay stack -->
    <div id="stack">
      <div class="panel open" id="pLegend">
        <header><div>Legend</div><div>▾</div></header>
        <div class="content">
          <div class="row"><span class="badge b20">20 psi</span> severe collapse</div>
          <div class="row"><span class="badge b5">5 psi</span> heavy damage</div>
          <div class="row"><span class="badge b1">1 psi</span> light damage</div>
          <div class="row"><span class="badge bth">Thermal 3rd°</span> burns</div>
          <div class="row"><span class="badge bfo">Fallout</span> dose plume</div>
          <div class="note">Tap any ring/plume for text and population.</div>
        </div>
      </div>

      <div class="panel open" id="pTiles">
        <header><div>Tiles / Terrain</div><div>▾</div></header>
        <div class="content">
          <div class="row">
            <button class="smallbtn" id="btnRefresh2">Refresh tiles</button>
            <select id="bmSel"><option value="auto" selected>Auto</option><option value="osm">OSM Streets</option><option value="sat">ESRI Satellite</option><option value="grid">Offline grid</option></select>
          </div>
          <div class="row">
            <label><input id="terrainOn" type="checkbox" checked> Terrain (3D)</label>
            <label><input id="hillshadeOn" type="checkbox" checked> Hillshade</label>
          </div>
          <div class="row">Exaggeration <input id="exagg" type="range" min="1" max="3" step="0.1" value="1.4"><span id="exVal" style="width:36px;text-align:right">1.4</span></div>
          <div class="note">Tilt with two fingers. Turn off terrain if device is slow.</div>
        </div>
      </div>

      <div class="panel" id="pOver">
        <header><div>Overlays / Population</div><div>▾</div></header>
        <div class="content">
          <div class="row"><label><input id="popHeat" type="checkbox"> Population heat (county)</label></div>
          <div class="row">Precip intensity <input id="precip" type="range" min="0" max="100" value="20"><span id="precipVal" style="width:36px;text-align:right">20</span></div>
          <div class="row">Humidity <input id="humid" type="range" min="0" max="100" value="40"><span id="humidVal" style="width:36px;text-align:right">40</span></div>
          <div id="popRead" class="note">Population in current effects: —</div>
          <button class="smallbtn" id="calcPop">Recalc population</button>
        </div>
      </div>

      <div class="panel" id="pShelter">
        <header><div>Shelter Finder (terrain-aware)</div><div>▾</div></header>
        <div class="content">
          <div class="row">
            <button class="smallbtn" id="btnGPS">My Position (GPS)</button>
            <select id="radius">
              <option value="250">250 m</option>
              <option value="500" selected>500 m</option>
              <option value="1000">1 km</option>
              <option value="1500">1.5 km</option>
            </select>
          </div>
          <div class="row">
            <button class="smallbtn" id="findShelter">Suggest</button>
            <button class="smallbtn" id="clearShelter">Clear</button>
          </div>
          <div class="note">Dots: <span class="mini-help" style="color:#22c55e">green</span> better (leeward/lower); <span class="mini-help" style="color:#f59e0b">orange</span> avoid.</div>
          <div id="shelterRead" class="note">—</div>
        </div>
      </div>

      <!-- Pins / Waypoints -->
      <div class="panel" id="pPins">
        <header><div>Pins / Waypoints</div><div>▾</div></header>
        <div class="content">
          <div class="row" style="gap:6px;flex-wrap:wrap">
            <select id="pinType">
              <option value="custom" selected>Custom</option>
              <option value="home">Home</option>
              <option value="work">Work</option>
              <option value="cache">Cache</option>
              <option value="friend">Family/Friend</option>
              <option value="checkpoint">Checkpoint</option>
              <option value="op">Observation Post</option>
              <option value="shelter">Shelter</option>
              <option value="threat">Threat/Militant</option>
            </select>
            <input id="pinColor" type="color" value="#22c55e" title="Pin color">
            <button class="smallbtn" id="pinAddNow">Drop at map center</button>
            <button class="smallbtn" id="pinClearAll">Clear pins</button>
          </div>
          <div class="note">Tip: turn on “Add pin (tap map)”, then tap the map. Drag a pin to move it. Tap a pin to edit.</div>
          <div class="pin-list" id="pinList"><div class="note">No pins yet.</div></div>
        </div>
      </div>

      <!-- Waypoints & Timers -->
      <div class="panel" id="pWT">
        <header><div>Waypoints & Timers</div><div>▾</div></header>
        <div class="content">
          <div class="row">
            <button id="homeCenter" class="smallbtn">Home → Center</button>
            <button id="workCenter" class="smallbtn">Work → Center</button>
            <button id="goSelected" class="smallbtn">Center on selected</button>
          </div>
          <div class="row">
            <label class="lbl">Adversary ETA</label>
            <input id="advWins" class="num xs" type="number" min="1" step="1" value="60"><span class="note"> min window</span>
            <button id="advStart" class="smallbtn">Start</button>
            <button id="advStop" class="smallbtn">Stop</button>
          </div>
          <div id="advShow" class="note">—</div>
        </div>
      </div>
    </div>

    <!-- Wind HUD -->
    <div id="windHUD">
      <div id="windHead"><div class="title">Wind / Fallout Timing</div><div id="windRead" class="note">90° (E), 10 m/s</div></div>
      <div id="windBody">
        <canvas id="windCompass" width="120" height="120"></canvas>
        <div>
          <div class="note">Drag arrow • 0–359°</div>
          <div id="hudEta" class="eta">ETA to you: —</div>
          <div id="hudLeave" class="note">Leave-shelter est: —</div>
          <div id="windSrc" class="note">—</div>
        </div>
      </div>
      <div id="windFoot">
        <input id="windNum" type="number" min="0" max="359" step="1" value="90">
        <input id="windNumSpd" type="number" min="0" max="60" step="1" value="10">
        <button id="windCenter" class="smallbtn">Reset pos</button>
        <button id="windHide" class="smallbtn">Hide</button>
      </div>
      <div id="windResize" title="Resize"></div>
    </div>

    <div id="err" class="err"></div>
  </div>
</div>

<!-- Tiny county demo; replace with counties.json for full coverage if you want -->
<script id="countiesData" type="application/json">
{
  "type":"FeatureCollection",
  "features":[
    {"type":"Feature","properties":{"name":"Columbia, OR","pop":52800},"geometry":{"type":"Polygon","coordinates":[[[-123.42,45.95],[-123.42,45.55],[-122.65,45.55],[-122.65,46.20],[-123.42,45.95]]]}},
    {"type":"Feature","properties":{"name":"Clatsop, OR","pop":41100},"geometry":{"type":"Polygon","coordinates":[[[-124.10,46.30],[-124.10,45.80],[-123.50,45.80],[-123.50,46.30],[-124.10,46.30]]]}},
    {"type":"Feature","properties":{"name":"Cowlitz, WA","pop":111000},"geometry":{"type":"Polygon","coordinates":[[[-123.30,46.60],[-123.30,46.00],[-122.48,46.00],[-122.48,46.60],[-123.30,46.60]]]}},
    {"type":"Feature","properties":{"name":"Clark, WA","pop":503000},"geometry":{"type":"Polygon","coordinates":[[[-123.30,45.90],[-123.30,45.50],[-122.20,45.50],[-122.20,45.90],[-123.30,45.90]]]}},
    {"type":"Feature","properties":{"name":"Multnomah, OR","pop":815000},"geometry":{"type":"Polygon","coordinates":[[[-122.95,45.70],[-122.95,45.40],[-122.25,45.40],[-122.25,45.70],[-122.95,45.70]]]}},
    {"type":"Feature","properties":{"name":"Washington, OR","pop":606000},"geometry":{"type":"Polygon","coordinates":[[[-123.40,45.80],[-123.40,45.30],[-122.70,45.30],[-122.70,45.80],[-123.40,45.80]]]}},
    {"type":"Feature","properties":{"name":"Tillamook, OR","pop":27300},"geometry":{"type":"Polygon","coordinates":[[[-123.95,45.75],[-123.95,45.20],[-123.40,45.20],[-123.40,45.75],[-123.95,45.75]]]}},
    {"type":"Feature","properties":{"name":"Yamhill, OR","pop":110000},"geometry":{"type":"Polygon","coordinates":[[[-123.50,45.60],[-123.50,45.10],[-122.95,45.10],[-122.95,45.60],[-123.50,45.60]]]}},
    {"type":"Feature","properties":{"name":"Polk, OR","pop":91000},"geometry":{"type":"Polygon","coordinates":[[[-123.65,45.20],[-123.65,44.70],[-122.95,44.70],[-122.95,45.20],[-123.65,45.20]]]}},
    {"type":"Feature","properties":{"name":"Marion, OR","pop":353000},"geometry":{"type":"Polygon","coordinates":[[[-123.25,45.10],[-123.25,44.50],[-122.25,44.50],[-122.25,45.10],[-123.25,45.10]]]}},
    {"type":"Feature","properties":{"name":"Lincoln, OR","pop":51000},"geometry":{"type":"Polygon","coordinates":[[[-124.30,45.10],[-124.30,44.40],[-123.75,44.40],[-123.75,45.10],[-124.30,45.10]]]}},
    {"type":"Feature","properties":{"name":"Benton, OR","pop":96000},"geometry":{"type":"Polygon","coordinates":[[[-123.60,44.80],[-123.60,44.30],[-123.05,44.30],[-123.05,44.80],[-123.60,44.80]]]}},
    {"type":"Feature","properties":{"name":"Pacific, WA","pop":23000},"geometry":{"type":"Polygon","coordinates":[[[-124.10,46.80],[-124.10,46.30],[-123.50,46.30],[-123.50,46.80],[-124.10,46.80]]]}},
    {"type":"Feature","properties":{"name":"Wahkiakum, WA","pop":4500},"geometry":{"type":"Polygon","coordinates":[[[-123.60,46.45],[-123.60,46.20],[-123.20,46.20],[-123.20,46.45],[-123.60,46.45]]]} }
  ]
}
</script>

<!-- app script removed -->
  <!-- error toast lives inside the existing mapwrap (do NOT reopen #app/#mapwrap) -->
  <div id="status"></div>
  <div id="hint" class="hint"></div>
  <div id="err" class="err"></div>

</div><!-- /mapwrap -->
</div><!-- /app -->

<!-- Single external script include -->
<script src="app.js"></script>
</body>
</html>
